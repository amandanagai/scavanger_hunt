{% extends 'base.html' %}
{% block content %}
  <style>
    /* Always set the map height explicitly to define the size of the div
     * element that contains the map. */
    #map {
      height: 100%;
    }
    /* Optional: Makes the sample page fill the window. */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>

  <form action="{{url_for('locations.geocode', user_id=current_user.id, id=id)}}">
    <input type="hidden" id="user_id" value="{{current_user.id}}">
    <input type="hidden" id="hunt_id" value="{{id}}">
    <input class="place" type="text" placeholder="type a place">
    <input class="submitSearch" type="submit" value="search">
  </form>
  <a class="btn btn-primary btn-xs" href="{{url_for('hunts.show', user_id=current_user.id, id=id)}}">Back to list</a>

  <div id="map"></div>
  
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?v=3.27&key=AIzaSyD3GR4qurOOFeNGD2U3ar8YhD8hQ3hIR8U&signed_in=true">
  </script>

  <script>
      var $submitSearch = $('.submitSearch');
      var markers = [];

      $submitSearch.on("click", function(e){
        e.preventDefault();
        var $place = $('.place').val();
        var $userId = $('#user_id').val();
        var $huntId = $('#hunt_id').val();
      
      $.ajax({
          method: 'post',
          url: `/users/${$userId}/hunts/${$huntId}/locations/geocode`,    
          data: {
              place: $place
          }
        })
      .then(function(res){
        var newPlace = {lat: res[0], lng: res[1]};
        var search = res[2];
        var map;
        initMap();
        // addMarker(newPlace);
        // setMapOnAll(map);
        // showMarkers();

        function initMap() {
          map = new google.maps.Map(document.getElementById('map'), {
            zoom: 17,
            center: newPlace
          });
          createMarker(newPlace, map);
        }

        // function setMapOnAll(map) {
        //   for (var i = 0; i < markers.length; i++) {
        //     markers[i].setMap(map);
        //   }
        // }

        // function showMarkers() {
        //   setMapOnAll(map);
        // }


        // function addMarker(location) {
        //   var marker = new google.maps.Marker({
        //     position: location,
        //     map: map
        //   });
        //   markers.push(marker);
        // }

        function createMarker(newPlace, map) {
          var marker = new google.maps.Marker({
            map: map,
            position: newPlace,
            // // Attributions help users find your site again.
            // attribution: {
            //   source: 'Google Maps JavaScript API',
            //   webUrl: 'https://developers.google.com/maps/'
            // }
          });
        //   markers.push(marker)

          // Construct a new InfoWindow.
          var infoWindow = new google.maps.InfoWindow({
            content: `${search}: double click marker to add location to hunt`
          });

          // Opens the InfoWindow when marker is clicked.
          marker.addListener('click', function() {
            infoWindow.open(map, marker);
          });
            
          marker.addListener('dblclick', function(e){
              // e.preventDefault();
              $.ajax({
                method: 'post',
                url: `/users/${$userId}/hunts/${$huntId}/locations/`,    
                data: {
                  lat: newPlace['lat'],
                  lng: newPlace['lng'],
                  place: search
                }
              })
              .then(function(res){ 
                  function deleteSearchMarker() {
                    markers.pop()
                  }
                  var added = new google.maps.Marker({
                    map: map,
                    position: newPlace,
                    label: `#${res[3]}`
                  });
                  markers.push(added);
              })
          });
        }
        });
        })
  </script>

{% endblock %}